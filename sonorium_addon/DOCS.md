# Sonorium v2 Beta Documentation\n\n## Table of Contents\n\n- [Configuration](#configuration)\n- [Audio Setup](#audio-setup)\n- [Sessions & Channels](#sessions--channels)\n- [Speaker Management](#speaker-management)\n- [API Reference](#api-reference)\n- [Home Assistant Integration](#home-assistant-integration)\n- [Performance Tuning](#performance-tuning)\n- [Troubleshooting](#troubleshooting)\n\n---\n\n## Configuration\n\n### Addon Options\n\n| Option | Type | Default | Description |\n|--------|------|---------|-------------|\n| `sonorium__stream_url` | string | `http://homeassistant.local:8008` | Base URL for audio streams. **Must use IP address for speaker compatibility.** |\n| `sonorium__path_audio` | string | `/media/sonorium` | Path to theme folders containing audio files |\n| `sonorium__max_channels` | integer | `6` | Maximum concurrent streaming channels (1-10) |\n\n### Example Configuration\n\n```yaml\nsonorium__stream_url: \"http://192.168.1.100:8008\"\nsonorium__path_audio: \"/media/sonorium\"\nsonorium__max_channels: 4\n```\n\n### Important Notes\n\n1. **Stream URL**: Use your Home Assistant's IP address (e.g., `192.168.1.100`), not `homeassistant.local`. Many speakers (Sonos, Chromecast, Echo) cannot resolve mDNS hostnames.\n\n2. **Port**: The beta addon uses port `8008` internally, mapped to `8008` externally. This runs alongside the stable addon on port `8007`.\n\n3. **Max Channels**: Set this based on your hardware. See the [Performance Guide](README.md#-performance-considerations) in the README.\n\n---\n\n## Audio Setup\n\n### Directory Structure\n\n```\n/media/sonorium/\n├── Thunder/\n│   ├── distant_rumble.mp3\n│   ├── rain_heavy.mp3\n│   ├── rain_light.ogg\n│   └── wind_storm.wav\n├── Forest/\n│   ├── birds_dawn.mp3\n│   ├── creek_flowing.flac\n│   └── wind_trees.mp3\n├── Ocean/\n│   └── waves_shore.mp3\n└── Fireplace/\n    ├── fire_crackle.mp3\n    └── wood_pop.mp3\n```\n\n### Supported Audio Formats\n\n| Format | Extension | Notes |\n|--------|-----------|-------|\n| MP3 | `.mp3` | Recommended for size/quality balance |\n| WAV | `.wav` | Uncompressed, large files |\n| FLAC | `.flac` | Lossless compression |\n| Ogg Vorbis | `.ogg` | Open format alternative |\n\n### Theme Guidelines\n\n1. **Naming**: Folder name becomes the theme name (e.g., `Thunder/` → \"Thunder\")\n2. **Multiple Tracks**: All files in a folder are mixed together automatically\n3. **Single Track**: Single-file themes loop seamlessly with crossfade\n4. **Track Count**: 5-20 tracks per theme recommended for best performance\n5. **File Length**: Longer files (2+ minutes) work best for natural looping\n\n### Audio Specifications\n\n| Property | Recommendation |\n|----------|---------------|\n| Sample Rate | 44.1kHz or 48kHz |\n| Bit Depth | 16-bit |\n| Channels | Mono or Stereo (converted to mono for mixing) |\n| Bitrate (MP3) | 128-192kbps |\n\n---\n\n## Sessions & Channels\n\n### Concepts\n\n**Session**: A named playback configuration consisting of:\n- Selected theme\n- Selected speakers (via group or ad-hoc)\n- Volume setting\n- Playback state\n\n**Channel**: A persistent audio stream endpoint. When you play a session:\n1. A channel is assigned to the session\n2. The theme is loaded into the channel\n3. Speakers connect to `/stream/channel{n}`\n4. Theme changes trigger crossfade within the channel (no reconnection needed)\n\n### Session Lifecycle\n\n```\nCreate Session → Configure (theme, speakers) → Play → [Change Theme] → Stop → Delete\n                                                ↓\n                                        Channel assigned\n                                                ↓\n                                        Speakers connect\n                                                ↓\n                                        Audio streams\n```\n\n### Channel Allocation\n\n- Channels are numbered 1 through `max_channels`\n- When you press Play, the lowest available channel is assigned\n- When you Stop, the channel is released\n- Multiple speakers can connect to the same channel (same audio)\n- Different sessions use different channels (different audio)\n\n### Theme Crossfading\n\nWhen you change themes on a playing session:\n1. Each connected speaker detects the theme change\n2. A 3-second equal-power crossfade begins\n3. Old theme fades out while new theme fades in\n4. Speakers never disconnect/reconnect\n\n---\n\n## Speaker Management\n\n### Discovery\n\nSonorium discovers speakers from Home Assistant's entity registry:\n- All `media_player.*` entities are discovered\n- Entities are organized by their assigned floor and area\n- Refresh manually via `/api/speakers/refresh`\n\n### Speaker Hierarchy\n\n```\nFloor (e.g., \"First Floor\")\n└── Area (e.g., \"Living Room\")\n    └── Speaker (e.g., \"media_player.living_room_sonos\")\n```\n\n### Selection Methods\n\n**By Floor**: Select all speakers on a floor\n```json\n{\n  \"include_floors\": [\"floor_first\"],\n  \"exclude_speakers\": [\"media_player.kitchen_echo\"]\n}\n```\n\n**By Area**: Select all speakers in specific areas\n```json\n{\n  \"include_areas\": [\"area_living_room\", \"area_bedroom\"]\n}\n```\n\n**By Speaker**: Select individual speakers\n```json\n{\n  \"include_speakers\": [\"media_player.office_sonos\"]\n}\n```\n\n### Speaker Groups\n\nSave frequently-used speaker combinations as groups:\n\n```json\n{\n  \"name\": \"Downstairs\",\n  \"include_floors\": [\"floor_first\"],\n  \"exclude_areas\": [\"area_garage\"]\n}\n```\n\n---\n\n## API Reference\n\n### Base URL\n\n```\nhttp://[your-ha-ip]:8008/api/\n```\n\n### Sessions\n\n#### List Sessions\n```http\nGET /api/sessions\n```\n\nResponse:\n```json\n[\n  {\n    \"id\": \"abc12345\",\n    \"name\": \"Living Room\",\n    \"theme_id\": \"thunder\",\n    \"is_playing\": true,\n    \"volume\": 50,\n    \"channel_id\": 1,\n    \"speakers\": [\"media_player.living_room_sonos\"],\n    \"speaker_summary\": \"Living Room Sonos\"\n  }\n]\n```\n\n#### Create Session\n```http\nPOST /api/sessions\nContent-Type: application/json\n\n{\n  \"theme_id\": \"thunder\",\n  \"adhoc_selection\": {\n    \"include_areas\": [\"area_living_room\"]\n  },\n  \"volume\": 50\n}\n```\n\n#### Update Session\n```http\nPUT /api/sessions/{id}\nContent-Type: application/json\n\n{\n  \"theme_id\": \"forest\",\n  \"volume\": 60\n}\n```\n\n#### Play Session\n```http\nPOST /api/sessions/{id}/play\n```\n\nResponse:\n```json\n{\n  \"status\": \"playing\",\n  \"channel_id\": 1\n}\n```\n\n#### Stop Session\n```http\nPOST /api/sessions/{id}/stop\n```\n\n#### Set Volume\n```http\nPOST /api/sessions/{id}/volume\nContent-Type: application/json\n\n{\n  \"volume\": 75\n}\n```\n\n### Channels\n\n#### List Channels\n```http\nGET /api/channels\n```\n\nResponse:\n```json\n[\n  {\n    \"id\": 1,\n    \"name\": \"Channel 1\",\n    \"state\": \"playing\",\n    \"current_theme\": \"thunder\",\n    \"current_theme_name\": \"Thunder\",\n    \"client_count\": 3,\n    \"stream_path\": \"/stream/channel1\"\n  }\n]\n```\n\n### Themes\n\n#### List Themes\n```http\nGET /api/themes\n```\n\nResponse:\n```json\n[\n  {\n    \"id\": \"thunder\",\n    \"name\": \"Thunder\",\n    \"track_count\": 4,\n    \"url\": \"http://192.168.1.100:8008/stream/thunder\"\n  }\n]\n```\n\n### Speakers\n\n#### Get Hierarchy\n```http\nGET /api/speakers/hierarchy\n```\n\nResponse:\n```json\n{\n  \"floors\": [\n    {\n      \"id\": \"floor_first\",\n      \"name\": \"First Floor\",\n      \"areas\": [\n        {\n          \"id\": \"area_living_room\",\n          \"name\": \"Living Room\",\n          \"speakers\": [\n            {\n              \"entity_id\": \"media_player.living_room_sonos\",\n              \"name\": \"Living Room Sonos\"\n            }\n          ]\n        }\n      ]\n    }\n  ]\n}\n```\n\n---\n\n## Home Assistant Integration\n\n### Native Services Used\n\n| Service | Purpose |\n|---------|---------|\n| `media_player.play_media` | Send stream URL to speakers |\n| `media_player.volume_set` | Set speaker volume |\n| `media_player.media_stop` | Stop playback |\n| `media_player.media_pause` | Pause playback |\n\n### Future Native Integration Goals\n\nWe aim to maximize use of native HA features:\n\n1. **Media Player Entities**: Sessions exposed as `media_player.sonorium_*` entities\n2. **Media Browser**: Theme selection via HA Media Browser\n3. **Scenes**: Link sessions to HA scenes\n4. **Automations**: Trigger playback via HA automations\n5. **Voice Assistants**: \"Hey Google, play thunder sounds in the living room\"\n\n### Current MQTT Entities (v1 Compatibility)\n\n| Entity | Type | Description |\n|--------|------|-------------|\n| `select.sonorium_theme` | Select | Choose active theme |\n| `select.sonorium_media_player` | Select | Target speaker |\n| `number.sonorium_master_volume` | Number | Master volume (0-100) |\n| `switch.sonorium_play` | Switch | Play/Pause toggle |\n\n---\n\n## Performance Tuning\n\n### Monitoring\n\nCheck addon logs for performance indicators:\n```\nChannel 1: Client connected (3 total)\nCrossfadeStream: chunk #500, samples=512000\nStarted playback on 5/5 speakers\n```\n\n### Optimization Strategies\n\n1. **Reduce Track Count**: Themes with 5-10 tracks use less CPU than 50+ tracks\n2. **Lower Max Channels**: Set to only what you need\n3. **Longer Audio Files**: Reduces file switching overhead\n4. **Consistent Sample Rates**: 44.1kHz across all files avoids resampling\n\n### Memory Usage Estimate\n\n```\nBase addon:        ~100MB\nPer theme loaded:  ~20-50MB (depends on track count)\nPer active stream: ~50-100MB (encoding buffers)\n```\n\n### CPU Usage Factors\n\n| Factor | Impact |\n|--------|--------|\n| Track count per theme | High - each track is decoded and mixed |\n| Number of active channels | High - each channel does independent encoding |\n| Connected clients | Medium - each client has encoding overhead |\n| Audio file format | Low - FLAC slightly higher than MP3 |\n\n---\n\n## Troubleshooting\n\n### Common Issues\n\n#### \"Generator already executing\" Error\n**Fixed in v2.0.0b4**. Update to latest version.\n\n#### Speakers Don't Play\n1. Verify `stream_url` uses IP address, not hostname\n2. Check speaker supports HTTP stream URLs\n3. Test URL directly: `http://[ip]:8008/stream/channel1` in browser\n4. Check addon logs for errors\n\n#### Theme Not Appearing\n1. Verify folder exists in `/media/sonorium/`\n2. Check files have supported extensions\n3. Restart addon to rescan themes\n\n#### Audio Stuttering\n1. Reduce `max_channels`\n2. Check HA system CPU usage\n3. Reduce tracks per theme\n4. Ensure stable network to speakers\n\n#### Crossfade Not Working\n1. Must change theme while session is playing\n2. Check logs for \"Starting crossfade\" message\n3. Verify channel is in \"playing\" state\n\n### Log Locations\n\n- **Addon Logs**: Settings → Add-ons → Sonorium Beta → Logs\n- **State File**: `/config/sonorium/state.json`\n- **HA Core Logs**: Settings → System → Logs\n\n### Debug Mode\n\nEnable verbose logging in addon configuration (future feature).\n\n---\n\n## Version Information\n\n- **Current Version**: 2.0.0b5\n- **Minimum HA Version**: 2024.1.0\n- **Python Version**: 3.12\n- **Base Image**: hassio-addons/base:16.3.2\n\n## Links\n\n- [README](README.md)\n- [Roadmap](ROADMAP.md)\n- [Changelog](CHANGELOG.md)